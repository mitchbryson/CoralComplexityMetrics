# Coral Complexity Metrics
A free software tool for computing structural complexity metrics over 3D digital surface models

![](/media/coral_banner.jpg)

## Introduction
"Coral Complexity Metrics" is a free command line tool that computes a variety of structural complexity metrics over triangulated surface models of landscapes, constructed for example by using structure from motion. It accepts models in ply format and allows the user to specify regularly spaced square quadrats for which different measurements can be made. The program returns a csv formatted file which contains metrics including mean rugosity, mean and variance of height, mean slope and distribution of slope angles and topographic surface area. The software allows the user to specify a list of measurement scales (spatial resolutions) at which calculations are performed, allowing for the derivation of size-dependant complexity parameters such as fractal dimension.

"Coral Complexity Metrics" is released under a GNU General Public Licence that allows you to freely distribute and modify to code to suit your needs (see "LICENCE.txt" for more details).

If you use this tool in academic research, please consider citing:
```bibtex
@misc{CCM_brysonetal_github,
      title = {Coral Complexity Metrics: A free software tool for computing structural complexity metrics over 3D digital surface models}, 
      author = {Mitch Bryson and Gus Porter and Will Figueira},
      year = {2025},
      publisher = {GitHub},
      journal = {GitHub repository},
      howpublished = {\url{https://github.com/mitchbryson/CoralComplexityMetrics}},
}
```

## Building

The software is build via cmake (see CMakeLists.txt).
Dependancies: cmake, GSL (GNU Scientific Library)

## Pre-compiled executable for Windows

A pre-compiled version of the tool as a Windows executable is provided as a zip including library files is available [here](https://github.com/mitchbryson/CoralComplexityMetrics/blob/main/windows_builds/complexitymetrics1.0.0_windows.zip).

## Usage from the command line

complexitymetrics <plyfile> <quadrat_size> <spacing> <output_dir> <Quad Keep Area Ratio Threshold [optional]> <resolutions.txt [optional]>

<ul>
      <li>plyfile: a triangulated surface model in ply format.</li>
      <li>quadrat_size: size of quadrats (linear distance along one side
of a square quadrat)</li>
      <li>spacing: distance between centres of quadrats</li>
      <li>output_dir: name of directory to create and output results</li>
      <li>Quad Keep Area Ratio Threshold [optional, default 0.9]: Specifies
the minimum 2D surface area of data present in a quadratic for it
to be part of the output set (as a fraction of the square quadratic 
area)</li>
      <li>resolutions.txt [optional]: a text file containing a a list of 
terrain resolutions at which calculations are performed. If this
Option is not specified, calculations are performed only at the 
original mesh resolution.</li>
</ul>

## Acknowledgements

"Coral Complexity Metrics" was developed by Mitch Bryson, Gus Porter and Will Figueira, in a collaboration between the [Australian Centre for Robotics](https://www.sydney.edu.au/engineering/our-research/robotics-and-intelligent-systems/australian-centre-for-robotics.html) and the [School of Life and Environmental Sciences](https://www.sydney.edu.au/science/schools/school-of-life-and-environmental-sciences.html) at the [University of Sydney](https://www.sydney.edu.au/).

"tinyply" was originally developed Dimitri Diakopoulos ([https://github.com/ddiakopoulos/tinyply](https://github.com/ddiakopoulos/tinyply)) and is used to load/save 3D surface models in [PLY](https://en.wikipedia.org/wiki/PLY_(file_format)) format.

# Methods and Calculations:

## Mesh loading and quadrat creation
The program begins by loading the provided mesh file and recording the 3D locations of each of the three vertices of each triangular mesh face. Bounding box coordinates (in the original horizontal X-Y axes) are calculated and the center location of this box becomes the horizontal position of the center of the first quadrat. A horizontal grid of quadrats is generated by placing additional quadrats at regular intervals (with distance specified by the "spacing" parameter) out from this center point in each of the +/-X and +/-Y directions, until the quadrat coordinates lie outside of the bounding box. The 2D projected surface area of mesh terrain contained in each quadrat is calculated and used to determine whether a quadrat is maintained or discarded for further processing and output. Quadrats with a 2D area of at least "Quad Keep Area Ratio Threshold" (specified by the user) multiplied by the quadrat area are maintained.

## Calculation of slope and plane of best fit
A plane of best fit is calculated for the entire mesh. This plane forms a new coordinate system from which "plane-of-best-fit" metrics are calculated further along in the process. The plane parameters are calculated by finding the plane that minimises the perpendicular point-to-plane distances of the mesh vertices in the least squares sense. The angle this plane makes with the horizontal is recorded as the landscape-scale slope value for the whole mesh. The process is repeated for each quadrat (separate "plane-of-best fit" coordinates and slope values for each quadrat) by using only vertices that fall within the horizontal coordinates of each quadrat.

## Calculation of metrics across whole mesh and quadrats
A range of metrics (vertical relief, slope distribution, rugosity etc.) are calculated over both the whole mesh and for each quadrat. For the per-quadrat calculations, a subset of mesh vertices and triangles are used by including only triangles that are completely contained within the X-Y horizontal coordinates of the quadrat (according to the original coordinate system, not slope-adjusted coordinates).

## Calculation of height range parameters
The mean height, height range (difference between maximum and minimum) and height standard deviation for the whole mesh is calculated, according to the original X-Y coordinates of the mesh. Values are computed based on the mesh vertex height values. These three values are also computed for each of the quadrats by only using vertices that lie within the quadrat.

## Calculation of slope/vertical angle distribution
For the whole mesh and for each quadrat, a histogram of surface vertical angle distribution is calculated by analysing the slopes of each individual triangle. For each triangle of the mesh, a 3D normal vector N is calculated based on the coordinate of each vertex in the triangle:

$$N_x = (v_{y2}-v_{y1})(v_{z3}-v_{z1}) - (v_{z2}-v_{z1})(v_{y3}-v_{y1})$$
$$N_y = (v_{z2}-v_{z1})(v_{x3}-v_{x1}) - (v_{x2}-v_{x1})(v_{z3}-v_{z1})$$
$$N_z = (v_{x2}-v_{x1})(v_{y3}-v_{y1}) - (v_{y2}-v_{y1})(v_{x3}-v_{x1})$$

$$N = \frac{1}{\sqrt{N_x^2 + N_y^2 +N_z^2}}[N_x, N_y, N_z]$$

Where $v_{xi}$, $v_{yi}$, $v_{zi}$ correspond to the X-Y-Z coordinates of a triangle vertices $i$, where $i = {1,2,3}$. The angle between this vector and the z-axis of the original mesh coordinate system (positive upwards) is calculated (the face’s vertical angle $\theta$):

$$\theta = \cos^{-1}N_z$$

A histogram of these angles is computed in 10 degree bins for each triangle contained within the measurement subset corresponding to either the whole mesh or per-quadrat calculation.

## Calculation of area metrics and rugosity
For the whole mesh and then for each of the quadrats, a range of metrics corresponding to surface area and rugosity are calculated. The total 3D area of the surface ($A_{3D}$) is calculated by summing the areas of the individual triangles (indexed by j) in 3D space:

$$A_{3D} = \sum_{i=1}^n A_{3D,j}$$
$$A_{3D,j} = d_{avg}(d_{avg}-d_1)(d_{avg}-d_2)(d_{avg}-d_3)$$
$$d_{avg} = \frac{1}{3}(d_1 + d_2 + d_3)$$

$$d_1 = \sqrt{(v_{x2}-v_{x1})^2 + (v_{y2}-v_{y1})^2 + (v_{z2}-v_{z1})^2}$$
$$d_2 = \sqrt{(v_{x3}-v_{x2})^2 + (v_{y3}-v_{y2})^2 + (v_{z3}-v_{z2})^2}$$
$$d_3 = \sqrt{(v_{x1}-v_{x3})^2 + (v_{y1}-v_{y3})^2 + (v_{z1}-v_{z3})^2}$$

Where $d_1$, $d_2$, $d_3$ are the triangle edge lengths and $v_{xi}$, $v_{yi}$, $v_{zi}$ correspond to the X-Y-Z coordinates of a triangle's vertices. 

The total 2D projected area of the surface (A2D) is calculated by summing the total X-Y planar area occupied by the triangles when the z-axis values of each vertex are set to zero. In order to avoid double counting projected area corresponding to multiple triangles occupying the same X-Y coordinates (i.e. both the upper and lower surface of an overhanging surface, for which both parts of the surface occupy the same X-Y coordinates), a rasterised occupancy grid of the surface in the horizontal plane is computed (with a 100-by-100 grid resolution). The occupancy of each cell in the grid is set to “occupied” if there exists a triangle in the surface model such that the cell coordinate lies inside the X-Y coordinates of the triangle itself. Once each cell has been assessed, the 2D area is calculated by summing the number of occupied cells, dividing by the total number of cells and multiplying by the total area of the square quadrat.

Areal rugosity ($r$) for the surface is then calculated as the ratio between the 2D and 3D surface areas:

$$r = \frac{A_{2D}}{A_{3D}}$$

Values for 3D area, 2D projected area and rugosity are also computed based on the plane-of-best-fit coordinates for the whole mesh or each quadrat. A coordinate transformation is applied to each vertex in the mesh in order to place its coordinates in an X-Y-Z reference corresponding to the plane-of-best-fit, before calculating the metrics as described above.

## Multi-resolution metric calculation
In addition to calculating the metrics at the original mesh data, the program provides the ability for the user to specify several additional spatial resolutions at which to also calculate metrics. For each specified resolution, the program reconstructs a 2.5D approximation of the mesh surface at that resolution by 2D interpolation of the surface height value over a regularly spaced grid of X-Y coordinates, where the distance between points in either the X or Y directions is specified by the spatial resolution parameter. For each cell in the defined 2D grid, a vertex is created with the corresponding X-Y coordinates of the cell if at least one part of the original surface passes through that point. The z-coordinate of the vertex is defined by the average of the surface z-coordinate values accounting for all surface triangles within the grid cell. A new set of surface triangles are constructed by joining adjacent vertices together in the grid, leaving out sections of the grid for which vertices were not constructed (X-Y locations with no data in the original mesh file).

Once the reconstructed mesh is created, the whole suit of metrics (vertical relief, slope distribution, rugosity etc.) are calculated over this new mesh. Plane-of-best fit coordinates for the whole mesh and quadrats are kept from those calculated from the original mesh scale when calculating plane-of-best-fit metrics.


